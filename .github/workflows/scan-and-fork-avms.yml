name: Scan and Fork Azure Verified Modules

on:
  schedule:
    - cron: '0 0 * * 0'  # Run weekly
  workflow_dispatch:  # Allow manual triggers from GitHub web GUI

jobs:
  scan-and-fork:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate GitHub App token
        id: generate_token
        env:
          APP_ID: ${{ vars.TAVMLATEST_ADMIN_APPID }}
          PRIVATE_KEY: ${{ secrets.TAVMLATEST_ADMIN_PKEY }}
          INSTALLATION_ID: ${{ vars.TAVMLATEST_ADMIN_INSTALLATIONID }}
        run: |
          echo "Debug environment variables:"
          echo "APP_ID=$APP_ID"
          echo "PRIVATE_KEY=$PRIVATE_KEY"
          echo "INSTALLATION_ID=$INSTALLATION_ID"
          generate_jwt() {
            local now=$(date +%s)
            local payload=$(echo -n "{\"iat\":$now,\"exp\":$((now + 600)),\"iss\":$APP_ID}" | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
            local header=$(echo -n '{"alg":"RS256","typ":"JWT"}' | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
            local signature=$(echo -n "$header.$payload" | openssl dgst -sha256 -sign <(echo "$PRIVATE_KEY") | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
            echo "$header.$payload.$signature"
          }
          
          JWT=$(generate_jwt)
          TOKEN=$(curl -s -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens" \
            | jq -r .token)
          
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod a+x /usr/local/bin/yq

      - name: Scan Azure org for AVM repositories
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # Search for repositories matching the AVM naming convention
          repos=$(gh api -H "Accept: application/vnd.github+json" \
            /orgs/Azure/repos?per_page=100 \
            --jq '.[] | select(.name | test("^terraform-az(urerm|stack|ad)-avm-(res|pat)-")) | .name')

          # Update the YAML file
          echo "modules:" > config/modules.yml
          for repo in $repos; do
            echo "  - name: $repo" >> config/modules.yml
            echo "    repo: Azure/$repo" >> config/modules.yml
          done

          # Commit and push changes if there are any
          git config user.name "GitHub App"
          git config user.email "<>"
          git add config/modules.yml
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update AVM modules list" && git push)

      - name: Fork repositories to TAVMLatest
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # Read the updated modules.yml file
          repos=$(yq e '.modules[].repo' config/modules.yml)

          for repo in $repos; do
            # Check if fork already exists
            if ! gh repo view "TAVMLatest/$(basename $repo)" &>/dev/null; then
              echo "Forking $repo to TAVMLatest organization"
              gh repo fork "$repo" --org TAVMLatest --clone=false
            else
              echo "Fork already exists for $repo"
            fi
          done